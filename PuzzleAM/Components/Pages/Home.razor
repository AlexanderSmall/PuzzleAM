@page "/"
@rendermode InteractiveServer
@using PuzzleAM.Model
@using Microsoft.AspNetCore.Antiforgery
@using Microsoft.AspNetCore.Components.Authorization
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject AntiforgeryStateProvider Antiforgery
@inject DatabaseProviderInfo DatabaseProviderInfo
@using Microsoft.AspNetCore.Components.Forms

<div class="position-absolute top-0 end-0 p-3 d-flex align-items-center pe-none">
    @if (!string.IsNullOrEmpty(currentUsername))
    {
        <span class="me-2 pe-auto">@currentUsername</span>
    }
    <button class="btn btn-outline-primary me-2 pe-auto" data-bs-toggle="modal" data-bs-target="#registerModal">Create Account</button>
    @if (string.IsNullOrEmpty(currentUsername))
    {
        <button class="btn btn-outline-secondary pe-auto" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
    }
    else
    {
        <button class="btn btn-outline-secondary pe-auto" @onclick="Logout">Sign out</button>
    }
</div>

<h1 class="text-center fw-bold mt-5">Puzzle AM</h1>
<img src="images/AM_logo.png" alt="Puzzle AM logo" class="d-block mx-auto" style="width:20vw; filter: drop-shadow(rgba(0, 0, 0, 0.9) 0px 3px 10px);" />
<div class="d-flex flex-column align-items-center mt-3">
    <button class="btn btn-success mb-3" @onclick="CreateRoom">Create Room</button>
    <div class="input-group w-auto mb-2">
        <input class="form-control" @bind="joinCode" placeholder="Enter room code" />
        <button class="btn btn-primary" @onclick="JoinRoom">Join Room</button>
    </div>
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="text-danger">@errorMessage</div>
    }
    <div class="mt-3 text-muted">Currently using @DatabaseProviderInfo.ProviderDescription.</div>
</div>

<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <InputText @bind-Value="registerModel.Username" class="form-control" placeholder="Username" />
                <div class="input-group mt-2">
                    <InputText @bind-Value="registerModel.Password" type="password" class="form-control" placeholder="Password" />
                    <span class="input-group-text" data-bs-toggle="tooltip" data-bs-html="true" title="Password requirements:<br>- At least 6 characters<br>- At least one digit<br>- At least one lowercase letter<br>- At least one uppercase letter<br>- At least one non-alphanumeric character<br>- At least one unique character">&#9432;</span>
                </div>
                <InputText @bind-Value="registerModel.ConfirmPassword" type="password" class="form-control mt-2" placeholder="Confirm Password" />
                @if (!string.IsNullOrEmpty(registerError))
                {
                    <div class="text-danger mt-2">@registerError</div>
                }
                @if (!string.IsNullOrEmpty(registerMessage))
                {
                    <div class="text-success mt-2">@registerMessage</div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" @onclick="Register">Create Account</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Login</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <InputText @bind-Value="loginModel.Username" class="form-control" placeholder="Username" />
                <InputText @bind-Value="loginModel.Password" type="password" class="form-control mt-2" placeholder="Password" />
                @if (!string.IsNullOrEmpty(loginError))
                {
                    <div class="text-danger mt-2">@loginError</div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" @onclick="Login">Login</button>
            </div>
        </div>
    </div>
</div>

@code {
    private string? joinCode;
    private string? errorMessage;
    private RegisterModel registerModel = new();
    private LoginModel loginModel = new();
    private string? registerError;
    private string? registerMessage;
    private string? loginError;
    private string? currentUsername;
    [Inject]
    private AuthenticationStateProvider AuthenticationStateProvider { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUsername = user.Identity.Name;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initTooltips");
        }
    }

    private async Task CreateRoom()
    {
        var code = await JS.InvokeAsync<string>("createRoom");
        Nav.NavigateTo($"/puzzlegame/{code}");
    }

    private async Task JoinRoom()
    {
        if (string.IsNullOrWhiteSpace(joinCode)) return;
        var state = await JS.InvokeAsync<PuzzleState?>("joinRoom", joinCode);
        if (state is not null)
        {
            Nav.NavigateTo($"/puzzlegame/{joinCode}");
        }
        else
        {
            errorMessage = "Room code does not exist";
        }
    }

    private async Task Register()
    {
        if (registerModel.Password != registerModel.ConfirmPassword)
        {
            registerError = "Passwords do not match";
            registerMessage = null;
            return;
        }
        var token = Antiforgery.GetAntiforgeryToken();
        var result = await JS.InvokeAsync<RegisterResult>("register", token.Value, registerModel);
        if (result.Success)
        {
            registerError = null;
            registerMessage = "Account created successfully";
            currentUsername = registerModel.Username;
            Nav.NavigateTo("/", true);
        }
        else
        {
            registerError = string.IsNullOrWhiteSpace(result.Error)
                ? "Registration failed"
                : result.Error;
            registerMessage = null;
        }
    }

    private async Task Login()
    {
        var token = Antiforgery.GetAntiforgeryToken();
        var result = await JS.InvokeAsync<LoginResult>("login", token.Value, loginModel);
        if (result.Success)
        {
            loginError = null;
            currentUsername = loginModel.Username;
            Nav.NavigateTo("/", true);
        }
        else
        {
            loginError = string.IsNullOrWhiteSpace(result.Error)
                ? "Login failed"
                : result.Error;
        }
    }

    private async Task Logout()
    {
        var token = Antiforgery.GetAntiforgeryToken();
        var success = await JS.InvokeAsync<bool>("logout", token.Value);
        if (success)
        {
            currentUsername = null;
            Nav.NavigateTo("/", true);
        }
    }

    public class RegisterModel
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    public class RegisterResult
    {
        public bool Success { get; set; }
        public string? Error { get; set; }
    }

    public class LoginModel
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }

    public class LoginResult
    {
        public bool Success { get; set; }
        public string? Error { get; set; }
    }
}
